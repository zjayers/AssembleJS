name: Test Suite

on:
  pull_request:
    branches:
      - main
      - next
  push:
    branches:
      - main
      - next
  # Allow manual triggering
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [20.x, 22.x]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Type checking
        run: npm run check
      
      - name: Run linting
        run: npm run lint:dry
      
      - name: Run tests
        run: npm test
      
      - name: Build package
        run: npm run build
        
      - name: Cache build artifacts
        uses: actions/cache@v4
        with:
          path: |
            dist
            *.tgz
          key: ${{ runner.os }}-build-${{ github.sha }}-${{ matrix.node-version }}
  
  examples:
    runs-on: ubuntu-latest
    needs: test
    strategy:
      matrix:
        example: [
          'simple-preprocessor-example',
          'multi-ui-language-example',
          'advanced-preact-example'
        ]
        node-version: [20.x]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
      
      - name: Restore cached build artifacts
        uses: actions/cache@v4
        with:
          path: |
            dist
            *.tgz
          key: ${{ runner.os }}-build-${{ github.sha }}-20.x
          restore-keys: |
            ${{ runner.os }}-build-${{ github.sha }}-
      
      - name: Install dependencies and build if needed
        run: |
          npm ci
          # Only build if necessary (if artifacts weren't restored)
          if [ ! -d "dist" ]; then
            npm run build
          fi
      
      - name: Package for local use
        run: |
          # Only pack if necessary (if tgz wasn't restored)
          if [ ! -f "asmbl-v$(node -p "require('./package.json').version").tgz" ]; then
            npm pack
          fi

      - name: Install example dependencies
        run: |
          cd examples/${{ matrix.example }}
          npm install "file:./../../asmbl-v$(node -p "require('../../package.json').version").tgz" --no-save
          
      - name: Build example
        run: |
          cd examples/${{ matrix.example }}
          npm run build